<!DOCTYPE html>

<html>
<head lang="jp">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Emotion Recorder</title>
    <style type='text/css'>
        ul { list-style: none; }
        #recordingslist audio { display: block; margin-bottom: 10px; }
    </style>
    <link href="css/style.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" href="favicon.ico"/>
    <script src="js/jquery-1.11.0.min.js"></script>
    <script src="recorder.js"></script>
    <script type="text/javascript" src="js/excanvas.js"></script>
</head>
<body>
    <h1 class="text-center">Emotion Recorder</h1>

    <div class="well" style="max-width: 600px; margin: 0 auto 10px;">
        <button onclick="startRecording(this);" class="btn btn-lg btn-success btn-block">record</button>
        <button onclick="stopRecording(this);" disabled class="btn btn-lg btn-danger btn-block">stop</button>
        <button id="play" class="btn btn-lg btn-default btn-block">beep</button>
    </div>

    <div class="well" style="max-width: 600px; margin: 0 auto 10px;">
        <canvas id="c1" width="560" height="140"></canvas>
    </div>

    <h2 class="text-center">Recordings</h2>
    <ul id="recordingslist" class="well" style="max-width: 600px; margin: 0 auto 10px;"></ul>

    <h2 class="text-center">Log</h2>
    <pre id="log" class="well" style="max-width: 600px; margin: 0 auto 10px;"></pre>

    <script>
        function __log(e, data) {
            log.innerHTML += "\n" + e + " " + (data || '');
        }

        var audio_context;
        var recorder;
        var gainNode;
        var isRecording = false;
        var isBeeping = false;
        var y = 0;
        var ctx;

        function startRecording(button) {
            recorder && recorder.record();
            button.disabled = true;
            button.nextElementSibling.disabled = false;
            isRecording = true;
            __log('Recording...');
        }

        function stopRecording(button) {
            recorder && recorder.stop();
            button.disabled = true;
            button.previousElementSibling.disabled = false;
            isRecording = false;
            __log('Stopped recording.');

            // create WAV download link using audio data blob
            createDownloadLink();

            recorder.clear();
        }

        function createDownloadLink() {
            recorder && recorder.exportWAV(function(blob) {
            });
        }

        window.onload = function init() {
            try {
                // webkit shim
                window.AudioContext = window.AudioContext || window.webkitAudioContext;

                navigator.getUserMedia = ( navigator.getUserMedia ||
                                           navigator.webkitGetUserMedia ||
                                           navigator.mozGetUserMedia ||
                                           navigator.msGetUserMedia);
                window.URL = window.URL || window.webkitURL;

                audio_context = new AudioContext;
                __log('Audio context set up.');
                __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
            } catch (e) {
                alert('No web audio support in this browser!');
            }

            // Bufferを生成して、そこからChannelDataを取得する。
            var buffer = audio_context.createBuffer( 1, 48000 * 100, 48000 );
            var channel = buffer.getChannelData(0);

            // ChannelDataには1サンプルごとの音声データが入る。
            // とりあえず正弦波作って入れる。
            for( var i=0; i < channel.length; i++ ) {
                channel[i] = Math.sin( i / 100 * Math.PI);
            }
            __log('Beep is ready.');

            // Sourceを作る。これが入力になる。
            // 入力にBufferを入れる。
            var src = audio_context.createBufferSource();
            src.buffer = buffer;

            // 音量
            gainNode = audio_context.createGain();
            gainNode.gain.value = 0;
            src.connect(gainNode);
            __log('gainNode is ready.');

            // Modular Routing。Sourceをdest(出力)に直結する。
            gainNode.connect(audio_context.destination);

            src.start(audio_context.currentTime);
            isMute = true;

            recorder = new Recorder(gainNode);
            __log('Set source to output.');
            __log('All process is ready.');
            __log('');

            startDrawing();
        };

        $('#play').mousedown(function() {
            gainNode.gain.value = 100;
            isBeeping = true;
        });
        $('#play').mouseup(function() {
            gainNode.gain.value = 0;
            isBeeping = false;
        });

        function startDrawing() {
            var canvas = document.getElementById('c1');
            if ( ! canvas || ! canvas.getContext ) { return false; }
            ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.strokeStyle = 'rgb(60, 179, 113)';
            setTimeout(mes,100);
        }

        function mes() {
            if (isRecording) {
                y += 3;
                var x = 120;
                if (isBeeping) x = 20;
                ctx.arc(y, x, 1, 0, Math.PI*2, false);
                ctx.stroke();
            }
            setTimeout(mes,100);
        }
    </script>
</body>
</html>